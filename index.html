<!DOCTYPE html>
<html>
<head>
	<title>Covid-19 Live Dashboard for Sweden</title>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css">
	<script src="https://code.jquery.com/jquery-3.4.1.min.js"
		integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js"></script>
	<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>

<body>
	<div class="ui container">

		<div class="ui mini menu">
			<div class="red item">
				<i class="sync alternate icon"></i>
				<span id="last-updated"></span>
			</div>
			<a class="item" href="https://github.com/hisbarnabas/covid19-sweden" target="_blank">
				<i class="github icon"></i>
				<span class="computer only">Github</span>
			</a>
			<a class="item" href="https://en.wikipedia.org/wiki/2020_coronavirus_pandemic_in_Sweden" target="_blank">
				<i class="wikipedia w icon"></i>
				<span class="computer only">Covid-19</span>
			</a>
			<a class="item" href="https://www.krisinformation.se/en/hazards-and-risks/disasters-and-incidents/2020/official-information-on-the-new-coronavirus" target="_blank">
				<i class="info icon"></i>
				<span class="computer only">Official Info.</span>
			</a>
			<a class="item" href="tel:11313">
				<i class="phone icon"></i>
				<span class="computer only">113 13</span>
			</a>
		</div>

		<h2 class="ui header">
			Covid-19 Update for Sweden
		</h2>

		<div class="ui message">
			<p>This site crawls new data every 5 minutes.</p>
		</div>

		<div class="ui segment">
			<div class="ui small two statistics">
				<div class="statistic">
					<div id="stat-country-confirmed" class="value">0</div>
					<div class="label">Confirmed</div>
				</div>
				<div class="green statistic">
					<div id="stat-country-recovered" class="value">0</div>
					<div class="label">Recovered</div>
				</div>
				<div class="orange statistic">
					<div id="stat-country-severe" class="value">0</div>
					<div class="label">Severe</div>
				</div>
				<div class="red statistic">
					<div id="stat-country-deceased" class="value">0</div>
					<div class="label">Deceased</div>
				</div>
			</div>
			<div class="ui divider"></div>

			<div class="ui stackable two column grid">
				<div class="ten wide column">
					<div id="graph-line-country"></div>
				</div>
				<div class="six wide column">
					<div id="graph-bar-regions"></div>
				</div>
		</div>

		<div class="ui segment">
			<h3 class="ui header">
				Stats by Region (Län)
			</h3>

			<div id="dropdown-region" class="ui search selection dropdown">
				<input type="hidden" id="dropdown-region-selected" name="region">
				<div class="default text">Select Region (Län)</div>
				<i class="dropdown icon"></i>
				<div class="menu"></div>
			</div>

			<div class="ui hidden divider"></div>
			
			<div class="ui stackable two column grid">
				<div class="six wide column">
					<div class="table-scrollable">
					<table id="table-region-stats" class="ui compact unstackable table">
						<thead>
							<tr>
								<th>Date</th>
								<th class="right aligned">Confirmed</th>
							</tr>
							<tr>
								<th>Total</th>
								<th aria-type="confirmed" class="right aligned">0</th>
							</tr>
						</thead>
						<tbody></tbody>
					</table>
					</div>
				</div>
				<div class="ten wide column">
					<div id="graph-line-region"></div>
				</div>
			</div>
		</div>

		<div class="ui divider"></div>
		
		<p>Feel free to share this page to anyone. Written & maintained by <b>Barnie</b> (<a href="mailto:b@rala.life" target="_blank">b@rala.life</a>)</p>
	</div>

	<p>&nbsp;</p>

	<style>
		:root {
			--color-red: #db2828;
		}
		#graph-line-country svg {
			width: 100% !important;
		}
		/* Mobile */
		@media only screen and (max-width: 767px) {
			[class*="mobile hidden"],
			[class*="tablet only"]:not(.mobile),
			[class*="computer only"]:not(.mobile),
			[class*="large monitor only"]:not(.mobile),
			[class*="widescreen monitor only"]:not(.mobile),
			[class*="or lower hidden"] {
				display: none !important;
			}
		}
		.table-scrollable {
			max-height: 400px;
			overflow-y: scroll;
		}
		table tr.first-row {
			font-weight: bold;
		}
	</style>

	<script type="text/javascript">
	var colors = { grey: '#b0b0b0', black: '#000000', green: '#21ba45', red: '#db2828' };
	var dataURL = 'https://raw.githubusercontent.com/hisbarnabas/covid19-sweden/master/assets/data/latest.json';
	var updateData = function() {
		$.getJSON( dataURL, function ( json ) {

			var data_by_dates = json[ 'dates' ];
			var data_by_regions = json[ 'regions' ];

			var googleChartsLoaded = false;

			var graphLineOptionsCommon = {
				orientation: 'horizontal',
				lineWidth: 2,
				pointSize: 6,
				pointsVisible: true,
				legend: { position: 'top' },
				hAxis: { format: 'M/d' },
				vAxis: {
					minValue: 0,
					viewWindow: { min: 0 }
				},
				series: {
					0: { color: colors.grey },
					1: { color: colors.black }
				},
				chartArea: { top: 50, right: 20, bottom: 30, left: 50, width: "100%", height: "100%" },
				height: 400
			};

			var graphBarOptionsCommon = {
				height: 400,
				chartArea: { top: 10, right: 20, bottom: 20, left: 90, width: "100%", height: "100%" },
				bar: { groupWidth: '70%' },
				legend: { position: 'none' },
				bars: 'horizontal',
				colors: [ colors.black ]
			};

			/**
			 * Draw a line-chart with the country-wide stats
			 */
			var drawGraphCountry = function () {

				googleChartsLoaded = true;

				var data = new google.visualization.DataTable();
				data.addColumn( 'date', 'Date' );
				data.addColumn( 'number', 'Confirmed (New)' );
				data.addColumn( 'number', 'Confirmed (Total)' );

				var accumulated_confirmed = 0;
				Object.keys( data_by_dates ).forEach( function ( date, idx ) {
					var _tmp = date.split( '-' );
					var _date = new Date( parseInt( _tmp[ 0 ] ), parseInt( _tmp[ 1 ] ) - 1, parseInt( _tmp[ 2 ] ) );
					var _daily_confirmed = data_by_dates[ date ];
					accumulated_confirmed += _daily_confirmed;
					data.addRow( [ _date, _daily_confirmed, accumulated_confirmed ] );
				} );

				/**
				 * Makes sense to cut out the date before Feb 26, 2020,
				 * for it spreads out rapidly since then.
				 */
				var startDate = new Date( 2020, 1, 26 );
				var now = new Date();
				var tickDates = [];
				for ( var d = new Date( startDate ); d <= now; d.setDate( d.getDate() + 1 ) ) {
					tickDates.push( new Date( d ) );
				}

				var options = graphLineOptionsCommon;
				var options_hAxis = options.hAxis;
				options_hAxis.ticks = tickDates;
				options_hAxis.minValue = startDate;
				options_hAxis.viewWindow = { min: startDate };
				options.hAxis = options_hAxis;

				var chart = new google.visualization.LineChart( document.getElementById( 'graph-line-country' ) );
				chart.draw( data, options );

				// call to draw regional graph as well.
				drawGraphRegion();
			};

			/**
			 * Draw a line-chart with the regional stats
			 */
			var drawGraphRegion = function () {

				if ( ! googleChartsLoaded ) {
					return;
				}

				var region = $( '#dropdown-region-selected' ).val();
				if ( ! region ) {
					return;
				}

				var data_region = data_by_regions[ region ][ 'logs' ];

				var data = new google.visualization.DataTable();
				data.addColumn( 'date', 'Date' );
				data.addColumn( 'number', 'Confirmed (New)' );
				data.addColumn( 'number', 'Confirmed (Total)' );

				var accumulated_confirmed = 0;
				var accumulated_recovered = 0;
				var accumulated_deceased = 0;
				Object.keys( data_region ).forEach( function ( date, idx ) {
					var _tmp = date.split( '-' );
					var _date = new Date( parseInt( _tmp[ 0 ] ), parseInt( _tmp[ 1 ] ) - 1, parseInt( _tmp[ 2 ] ) );
					var _daily_confirmed = data_region[ date ];
					accumulated_confirmed += _daily_confirmed;
					data.addRow( [ _date, _daily_confirmed, accumulated_confirmed ] );
				} );

				/**
				 * Makes sense to cut out the date before Feb 26, 2020,
				 * for it spreads out rapidly since then.
				 */
				var startDate = new Date( 2020, 1, 26 );
				var now = new Date();
				var tickDates = [];
				for ( var d = new Date( startDate ); d <= now; d.setDate( d.getDate() + 1 ) ) {
					tickDates.push( new Date( d ) );
				}

				var options = graphLineOptionsCommon;
				var options_hAxis = options.hAxis;
				options_hAxis.ticks = tickDates;
				options_hAxis.minValue = startDate;
				options_hAxis.viewWindow = { min: startDate };
				options.hAxis = options_hAxis;

				var chart = new google.visualization.LineChart( document.getElementById( 'graph-line-region' ) );
				chart.draw( data, options );
			};

			/**
			 * Draw a table for the region
			 */
			var drawTableRegion = function () {

				var region = $( '#dropdown-region-selected' ).val();
				if ( ! region ) {
					return;
				}

				var data_region = data_by_regions[ region ][ 'logs' ];

				var _total = { confirmed: 0 };
				var _dates = Object.keys( data_region );

				_dates.reverse();

				var idx = 0;
				_dates.forEach( function ( _date ) {
					var _confirmed = data_region[ _date ];
					_total[ 'confirmed' ] += _confirmed;
					$( '#table-region-stats tbody' ).append(
						'<tr ' + ( idx === 0 ? 'class="first-row"' : '' ) + '>' +
							'<td>' + _date + '</td>' +
							'<td class="right aligned">' + _confirmed + '</td>' +
						'</tr>'
					);
					idx++;
				} );

				$( '#table-region-stats thead th[aria-type=confirmed]' ).text( _total[ 'confirmed' ] );
			}

			// Last updated.
			$( '#last-updated' ).text( json[ 'updated' ][ 'datetime' ] );

			// Country-wide stats.
			var summary = json[ 'summary' ];
			[ 'confirmed', 'recovered', 'severe', 'deceased' ].forEach( function( key, idx ) {
				$( '#stat-country-' + key ).text( summary[ key ] );
			} );

			// Regional stats.
			var region_keys = Object.keys( data_by_regions );
			var region_dropdown_items = [];
			var default_region = 'Stockholm';
			region_keys.forEach( function ( value ) {
				region_dropdown_items.push( {
					name: value,
					value: value,
					selected: ( value == default_region )
				} );
			} );

			// dropdown: region
			$( '#dropdown-region' )
				.dropdown( {
					values: region_dropdown_items,
					onChange: function ( value, text, item ) {

						// table: region
						$( '#table-region-stats tbody' ).empty();

						// draw the table
						drawTableRegion();

						// draw the graph
						drawGraphRegion();
					}
				} );

			// Google Charts
			google.charts.load( 'current', { 'packages': [ 'bar', 'corechart' ] } );
			google.charts.setOnLoadCallback( drawGraphCountry );
			google.charts.setOnLoadCallback( function(){

				// data_by_regions
				var data_by_regions_table = [
					[ 'Region', 'Confirmed (Total)' ]
				];
				region_keys.forEach( function( region ) {
					var _confirmed_total = data_by_regions[ region ]['total'];
					data_by_regions_table.push( [ region, _confirmed_total ] );
				} );

				var data = google.visualization.arrayToDataTable( data_by_regions_table );
				var options = graphBarOptionsCommon;
				var chart = new google.charts.Bar( document.getElementById( "graph-bar-regions" ) );
				chart.draw( data, options );
			});
		} );
	};

	$( document ).ready( function () {
		// update data
		updateData();

		// auto-refresh the data in every 5 minutes
		setInterval( updateData, 1000 * 60 * 5 );
	} );
	</script>

	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-160052627-2"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag() { dataLayer.push( arguments ); }
		gtag( 'js', new Date() );
		gtag( 'config', 'UA-160052627-2' );
	</script>

</body>
</html>
